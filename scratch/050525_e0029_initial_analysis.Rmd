---
title: "e0029_initial_analysis"
output: html_document
date: "2025-05-06"
---


# Load in packages

```{r, warning=FALSE}
library(tidyverse)
library(dplyr)
library(ggplot2)
library(readr)
library(ggrepel)
```




# Load in the Household Project dataset

```{r}

household_data <- read.table("C:/Users/anaes/OneDrive/UCI_Spring25/rotation/e0026-e0029-e0030.txt", header = TRUE)

# Divide dataset into separate tables by experiment
e0029 <- filter(household_data, str_detect(household_data$sample, "e0029"))

e0026 <- filter(household_data, str_detect(household_data$sample, "e0026"))

# Extract subject, day, household information
e0029_clean <- e0029 %>%
  mutate(
    subject = str_sub(biosample1, 1, -5),
    day = str_sub(biosample1, -3),
    household = str_sub(biosample1, 1, -6)
  )

# Specify output directory

OUTPUTDIR <- "./outputs"

# Define color palette

my_colors <- readRDS("C:/Spring-Rotation-2025/scratch/familyColorPalette.rds") 

```


### First plot composition across mixtures by biosample2 (donor community)


```{r}

# First get only the biosamples corresponding to actual mixtures
composition_across_mixes <- e0029 %>%
  # filter(!is.na(relAbundance)) %>%
  group_by(biosample2, replicate) %>%
  mutate(
    biosample1 = factor(biosample1, levels = unique(biosample1))  # sets the order of levels to match the order they appear within the current group
  ) %>%
  ungroup() # Remove the group structure to avoid it affecting during plotting



composition_across_mixes_plot <- ggplot(composition_across_mixes, aes(x = biosample1, y = relAbundance, fill = Family)) +
  geom_bar(stat = "identity") +
  scale_fill_manual(values = my_colors) +
  labs(
    title = "Community Composition Across Mixtures",
    x = "Biosample1",
    y = "Total Relative Abundance"
  ) +
  theme_gray() + 
  theme(
    legend.position = "none",
    axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1, size = 10),
    strip.text.x = element_text(angle = 90, hjust = 0, size = 15)
  ) +
  facet_grid(replicate ~ biosample2, scales = "free_x", space = "free_x")



ggsave(
  filename = file.path(OUTPUTDIR, "composition_across_mixes.png"),
  plot = composition_across_mixes_plot,
  width = 25,
  height = 10,
  dpi = 300
)

```



### Try looking at the opposite: composition across mixtures by biosample1 (donor community)


```{r}

# First get only the biosamples corresponding to actual mixtures. For blanks, only get the first well of the duplicates
composition_across_mixes <- e0029 %>%
  filter(!(biosample2 == "blank") | (biosample2 == "blank" & well %in% c("A11", "C11", "E11", "G11")) | (biosample1 == "blank" & well %in% "G12")) %>%
  group_by(biosample1, replicate) %>%
  mutate(
    biosample2 = factor(biosample2, levels = unique(biosample2))
  ) %>%
  ungroup()


# Why do the blank mixtures have an so many more observations?
composition_across_mixes %>%
  distinct(biosample1, biosample2, replicate) %>%  # ensure unique pairs
  group_by(biosample1) %>%
  summarise(n_biosample2 = n_distinct(biosample2)) %>%
  arrange(desc(n_biosample2))


composition_across_mixes_plot <- ggplot(composition_across_mixes, aes(x = biosample2, y = relAbundance, fill = Family)) +
  geom_bar(stat = "identity") +
  scale_fill_manual(values = my_colors) +
  labs(
    title = "Community Composition Across Mixtures",
    x = "Biosample2",
    y = "Total Relative Abundance"
  ) +
  theme_gray() + 
  theme(
    legend.position = "none",
    axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1, size = 10),
    strip.text.x = element_text(angle = 90, hjust = 0, size = 15)
  ) +
  facet_grid(replicate ~ biosample1, scales = "free_x", space = "free_x")

ggsave(
  filename = file.path(OUTPUTDIR, "composition_across_mixes_flipped.png"),
  plot = composition_across_mixes_plot,
  width = 25,
  height = 10,
  dpi = 300
)


```




### Question #1: Was colonization resistance affected by antibiotic treatment and did it recover by day 64?

Pseudocode:

Group by mixture

- For each of these unique communities, extract all OTU identities

- For the recipient communities we can do the same by looking at biosample1+blank mixtures?

- For the donor communities we have to go back to the e0026 dataset and extract the OTUs from there

**Only use ASVs with relAbundance > 0.0001**

```{r}

# Only extract OT
e0029_colonization <- e0029 %>% 
  filter(relAbundance > 0.0001)

e0026_colonization <- e0026 %>% 
  filter(relAbundance > 0.0001)

```


**Get mixture ASVs**

```{r}
  
# Replicate 1
mixture_ASVs_rep1 <- e0029_colonization %>%
  filter(replicate == 1) %>% 
  select(mixture, OTU) %>%
  distinct() %>%                        
  group_by(mixture) %>%
  summarise(asvs = list(unique(OTU)), .groups = "drop") %>%
  deframe()

# mixture_ASVs_rep1[["XBB-029+XBA-029"]]

#Replicate 2
mixture_ASVs_rep2 <- e0029_colonization %>%
  filter(replicate == 2) %>% 
  select(mixture, OTU) %>%
  distinct() %>%                        
  group_by(mixture) %>%
  summarise(asvs = list(unique(OTU)), .groups = "drop") %>%
  deframe()

```


**Get recipient ASVs**

```{r}



# Replicate 1
recipient_ASVs_rep1 <- e0029_colonization %>% 
  filter(replicate == 1, biosample2 == "blank", biosample1 != "blank") %>% 
  select(biosample1, OTU) %>%
  distinct() %>%                        
  group_by(biosample1) %>%
  summarise(asvs = list(unique(OTU)), .groups = "drop") %>%
  deframe()

# Replicate 2
recipient_ASVs_rep2 <- e0029_colonization %>% 
  filter(replicate == 2, biosample2 == "blank", biosample1 != "blank") %>% 
  select(biosample1, OTU) %>%
  distinct() %>%                        
  group_by(biosample1) %>%
  summarise(asvs = list(unique(OTU)), .groups = "drop") %>%
  deframe()

# recipient_ASVs_rep1[["XBA-029"]]

```


**Get donor ASVs**

```{r}

# Extract only the donor communities
donor_communities <- e0029_colonization %>%
  filter(!is.na(biosample2), biosample2 != "blank") %>%
  pull(biosample2) %>%
  unique()


# Extract single donor OTUs from e0026
donor_ASVs <- e0026_colonization %>% 
  filter(biosample1 %in% donor_communities, passage == "8") %>% 
  select(biosample1, OTU) %>%
  distinct() %>%
  group_by(biosample1) %>%
  summarise(asvs = list(unique(OTU)), .groups = "drop") %>%
  deframe()



# Infer mixture donor OTUs by adding together each pair:
donor_combinations <- list(
  "XBB-029+XKB-029" = c("XBB-029", "XKB-029"),
  "XCB-029+XBB-029" = c("XCB-029", "XBB-029"),
  "XDB-029+XCB-029" = c("XDB-029", "XCB-029"),
  "XEB-029+XDB-029" = c("XEB-029", "XDB-029"),
  "XFB-029+XEB-029" = c("XFB-029", "XEB-029"),
  "XGB-029+XFB-029" = c("XGB-029", "XFB-029"),
  "XHB-029+XGB-029" = c("XHB-029", "XGB-029"),
  "XIB-029+XHB-029" = c("XIB-029", "XHB-029"),
  "XJB-029+XIB-029" = c("XJB-029", "XIB-029")
)



extended_donor_ASVs <- donor_ASVs

for (combo_name in names(donor_combinations)) {
  component_donors <- donor_combinations[[combo_name]]
  
  # Combine OTUs using union() across selected donors
  combined_otus <- Reduce(union, donor_ASVs[component_donors])
  
  # Add to the extended list
  extended_donor_ASVs[[combo_name]] <- combined_otus

}


# Add b-mix info by computing the total asvs in the donor samples

combined_asvs_list <- list()

for (donor in names(extended_donor_ASVs)){
  
  donor_asvs <- extended_donor_ASVs[[donor]]

  combined_asvs_list <- append(combined_asvs_list, donor_asvs) # get all OTUs present in the 10 donors??
  combined_asvs_list <- Reduce(union, combined_asvs_list)
  
  extended_donor_ASVs[["b-mix"]] <- combined_asvs_list
}


```



### Define a function to categorize colonization


```{r, }

# This is what I have intuitively, but there 

compute_colonization <- function(mixture_list, donor_list, recipient_list) {
  colonization_results <- list()
  
  for (mix in names(mixture_list)) {
    mix_asvs <- mixture_list[[mix]]
    
    for (donor in names(donor_list)) {
      donor_asvs <- donor_list[[donor]]
      
      # Shared OTUs between mixture and donor
      shared_otus <- intersect(mix_asvs, donor_asvs)
      
      for (recipient in names(recipient_list)) {
        recipient_asvs <- recipient_list[[recipient]]
        
        # Flag colonization: 1 if OTU not in recipient, 0 if present
        colonization_flag <- ifelse(!(shared_otus %in% recipient_asvs), 1, 0)
        names(colonization_flag) <- shared_otus
        
        # Store in nested list
        colonization_results[[mix]][[donor]][[recipient]] <- colonization_flag
      }
    }
  }
  
  return(colonization_results)
}

colonization_results <- invisible(compute_colonization(mixture_ASVs_rep1, donor_ASVs, recipient_ASVs_rep1))


```



